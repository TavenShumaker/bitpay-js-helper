<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BitPay.js E2E Test Harness</title>
    <script src="https://bitpay.com/bitpay.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .status {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .status.ready {
        background: #1a3d1a;
        border: 1px solid #4caf50;
      }
      .status.error {
        background: #3d1a1a;
        border: 1px solid #f44336;
      }
      .event-log {
        background: #0d0d0d;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .event-item {
        margin-bottom: 5px;
        padding: 5px;
        border-bottom: 1px solid #222;
      }
      .event-item:last-child {
        border-bottom: none;
      }
      .timestamp {
        color: #888;
      }
      .event-type {
        color: #4caf50;
        font-weight: bold;
      }
      h1 {
        color: #fff;
        margin-bottom: 10px;
      }
      p {
        color: #aaa;
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>BitPay.js E2E Test Harness</h1>
    <p>This page is used by Playwright for automated E2E testing of bitpay.js integration.</p>

    <div id="status" class="status">Initializing...</div>

    <h2>Event Log</h2>
    <div id="event-log" class="event-log">
      <div style="color: #666;">Waiting for events...</div>
    </div>

    <script>
      // Test harness object exposed for Playwright
      window.testHarness = {
        events: [],
        ready: false,
        error: null,

        // Show an invoice - wrapper for bitpay.showInvoice
        showInvoice: function(invoiceId) {
          if (!window.bitpay) {
            throw new Error('bitpay.js not loaded');
          }
          window.bitpay.showInvoice(invoiceId);
        },

        // Clear all events (for resetting between tests)
        clearEvents: function() {
          window.testHarness.events = [];
          updateEventLog();
        },

        // Get events of a specific type
        getEventsByType: function(type) {
          return window.testHarness.events.filter(e => e.type === type);
        },

        // Check if a specific event type was received
        hasEvent: function(type) {
          return window.testHarness.events.some(e => e.type === type);
        }
      };

      // Update the visual event log
      function updateEventLog() {
        const logEl = document.getElementById('event-log');
        if (window.testHarness.events.length === 0) {
          logEl.innerHTML = '<div style="color: #666;">Waiting for events...</div>';
          return;
        }

        logEl.innerHTML = window.testHarness.events.map(event =>
          `<div class="event-item">
            <span class="timestamp">[${event.timestamp}]</span>
            <span class="event-type">${event.type}</span>
            ${event.data ? `: ${JSON.stringify(event.data)}` : ''}
          </div>`
        ).join('');

        // Auto-scroll to bottom
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Add an event to the log
      function addEvent(type, data = null) {
        const event = {
          type: type,
          timestamp: new Date().toISOString(),
          data: data
        };
        window.testHarness.events.push(event);
        updateEventLog();
        console.log('[TestHarness] Event:', type, data);
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        const statusEl = document.getElementById('status');

        // Check if bitpay.js loaded
        if (!window.bitpay) {
          window.testHarness.error = 'bitpay.js failed to load';
          statusEl.className = 'status error';
          statusEl.textContent = 'Error: bitpay.js failed to load from CDN';
          return;
        }

        // Verify all expected methods exist
        const expectedMethods = ['showInvoice', 'onModalWillEnter', 'onModalWillLeave', 'enableTestMode', 'setApiUrlPrefix'];
        const missingMethods = expectedMethods.filter(m => typeof window.bitpay[m] !== 'function');

        if (missingMethods.length > 0) {
          window.testHarness.error = `Missing methods: ${missingMethods.join(', ')}`;
          statusEl.className = 'status error';
          statusEl.textContent = `Error: Missing bitpay.js methods: ${missingMethods.join(', ')}`;
          return;
        }

        // Enable test mode to use test.bitpay.com
        window.bitpay.enableTestMode(true);

        // Register callbacks
        window.bitpay.onModalWillEnter(function() {
          addEvent('onModalWillEnter');
        });

        window.bitpay.onModalWillLeave(function() {
          addEvent('onModalWillLeave');
        });

        // Listen for postMessage events from BitPay
        window.addEventListener('message', function(event) {
          // Only accept messages from BitPay origins
          const trustedOrigins = ['https://bitpay.com', 'https://test.bitpay.com'];
          if (!trustedOrigins.includes(event.origin)) {
            return;
          }

          // Unwrap modal2 messages (same as bitpay.js does)
          var message = event.data;
          if (event.data && event.data.from === 'modal2') {
            message = event.data.message;
          }

          // Handle different message types
          if (typeof message === 'string') {
            // String messages like 'loaded', 'close'
            addEvent(message, { origin: event.origin });
          } else if (typeof message === 'object' && message !== null) {
            // Object messages like { status: '...' }
            if (message.status) {
              addEvent('status', { status: message.status, origin: event.origin });
            } else {
              addEvent('message', { data: message, origin: event.origin });
            }
          }
        });

        // Mark as ready
        window.testHarness.ready = true;
        statusEl.className = 'status ready';
        statusEl.textContent = 'Ready - bitpay.js loaded and callbacks registered';
        addEvent('harness_ready');
      });
    </script>
  </body>
</html>
